---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, render } from 'astro:content';
import config from '../../../config.json';

export async function getStaticPaths() {
  const articles = await getCollection('writing');
  return articles.map((article) => ({
    params: { slug: article.id },
    props: { article },
  }));
}

const { article } = Astro.props;
const { Content } = await render(article);

// Detect code blocks to conditionally load highlight.js
// We render to string to check, but Astro doesn't expose raw HTML pre-render.
// Instead, check the raw markdown body for fenced code blocks.
const hasCode = /```/.test(article.body ?? '');
---

<BaseLayout
  title={`${article.data.title} â€” ${config.site_name}`}
  description={article.data.title}
  activeNav="writing"
  hasCode={hasCode}
>
  <br />
  <a href="/writing" class="back-link">&larr; back to writing</a>

  <article>
    <header class="article-header">
      <h1 class="article-title">{article.data.title}</h1>
      <time class="article-date">{article.data.date}</time>
    </header>

    <div class="article-body">
      <Content />
    </div>
  </article>
</BaseLayout>

{hasCode && (
  <script>
    // Apply correct hljs theme on initial load
    if (document.documentElement.getAttribute('data-theme') === 'dark') {
      const link = document.createElement('link');
      link.rel = 'stylesheet';
      link.id = 'hljs-dark';
      link.href = 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css';
      document.head.appendChild(link);
      const light = document.getElementById('hljs-light') as HTMLLinkElement | null;
      if (light) light.disabled = true;
    }

    // Wire up theme toggle to also switch hljs stylesheet
    const toggleBtn = document.getElementById('theme-toggle');
    if (toggleBtn) {
      toggleBtn.addEventListener('click', () => {
        // Note: BaseLayout already toggled data-theme before this fires,
        // so at this point data-theme reflects the NEW theme.
        const nowDark = document.documentElement.getAttribute('data-theme') === 'dark';
        const light = document.getElementById('hljs-light') as HTMLLinkElement | null;
        if (nowDark) {
          let dark = document.getElementById('hljs-dark') as HTMLLinkElement | null;
          if (!dark) {
            dark = document.createElement('link');
            dark.rel = 'stylesheet';
            dark.id = 'hljs-dark';
            dark.href = 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css';
            document.head.appendChild(dark);
          } else {
            dark.disabled = false;
          }
          if (light) light.disabled = true;
        } else {
          if (light) light.disabled = false;
          const dark = document.getElementById('hljs-dark') as HTMLLinkElement | null;
          if (dark) dark.disabled = true;
        }
      });
    }

    // Run highlight.js and wrap code blocks with header + copy button
    document.querySelectorAll('.article-body pre').forEach((pre) => {
      const code = pre.querySelector('code');
      if (!code) return;

      (window as any).hljs.highlightElement(code);

      const langClass = [...code.classList].find((c) => c.startsWith('language-'));
      const lang = langClass ? langClass.replace('language-', '') : 'plaintext';

      const header = document.createElement('div');
      header.className = 'code-block-header';
      header.innerHTML = `<span>${lang}</span><button class="code-block-copy">copy</button>`;

      const wrapper = document.createElement('div');
      wrapper.className = 'code-block-wrapper';
      pre.parentNode!.insertBefore(wrapper, pre);
      wrapper.appendChild(header);
      wrapper.appendChild(pre);

      header.querySelector('.code-block-copy')!.addEventListener('click', function (this: HTMLButtonElement) {
        navigator.clipboard.writeText(code.innerText).then(() => {
          this.textContent = 'copied!';
          this.classList.add('copied');
          setTimeout(() => {
            this.textContent = 'copy';
            this.classList.remove('copied');
          }, 2000);
        });
      });
    });
  </script>
)}

<style>
  .back-link {
    color: var(--text-muted);
    font-size: 0.9rem;
    margin-bottom: 2rem;
    display: inline-block;
  }

  .article-header {
    margin-bottom: var(--space-lg);
  }

  .article-title {
    font-size: clamp(2rem, 4vw, 2.5rem);
    margin-bottom: 0.5rem;
    line-height: 1.1;
  }

  .article-date {
    font-family: monospace;
    color: var(--text-muted);
    font-size: 0.9rem;
  }

  /* Article body typography */
  .article-body {
    font-family: var(--font-serif);
    font-size: 1.15rem;
    line-height: 1.8;
    color: var(--text-main);
  }

  .article-body :global(p) {
    margin-bottom: 1.5rem;
  }

  .article-body :global(h2) {
    font-family: var(--font-sans);
    font-size: 1.75rem;
    font-weight: 700;
    letter-spacing: -0.02em;
    margin-top: 3rem;
    margin-bottom: 0.85rem;
    line-height: 1.2;
    padding-bottom: 0.4rem;
    border-bottom: 1px solid var(--border-color);
  }

  .article-body :global(h3) {
    font-family: var(--font-sans);
    font-size: 1.35rem;
    font-weight: 700;
    letter-spacing: -0.01em;
    margin-top: 2.5rem;
    margin-bottom: 0.6rem;
    line-height: 1.3;
  }

  .article-body :global(ul),
  .article-body :global(ol) {
    list-style: disc;
    padding-left: 1.75rem;
    margin-bottom: 1.5rem;
  }

  .article-body :global(ol) {
    list-style: decimal;
  }

  .article-body :global(li) {
    margin-bottom: 0.45rem;
  }

  .article-body :global(hr) {
    border: none;
    border-top: 1px dashed var(--border-color);
    margin: 2.5rem 0;
  }

  .article-body :global(blockquote) {
    border-left: 3px solid var(--border-color);
    padding: 0.25rem 0 0.25rem 1.25rem;
    color: var(--text-muted);
    margin: 0 0 1.5rem 0;
    font-style: italic;
  }

  .article-body :global(code) {
    font-family: ui-monospace, 'SF Mono', Menlo, Consolas, 'Courier New', monospace;
    font-size: 0.85em;
    background-color: var(--border-color);
    padding: 0.15em 0.45em;
    border-radius: 4px;
  }

  :global(html[data-theme="dark"]) .article-body :global(code) {
    background-color: #2a2a2a;
  }

  .article-body :global(pre) {
    background-color: #f5f5f5;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1.1rem 1.25rem;
    overflow-x: auto;
    margin-bottom: 1.75rem;
    font-size: 0.88rem;
    line-height: 1.65;
  }

  :global(html[data-theme="dark"]) .article-body :global(pre) {
    background-color: #1a1a1a;
    border-color: #2e2e2e;
  }

  .article-body :global(pre code) {
    background: none;
    padding: 0;
    border-radius: 0;
    font-size: inherit;
  }

  /* Code block wrapper (added by JS) */
  .article-body :global(.code-block-wrapper) {
    position: relative;
    margin-bottom: 1.75rem;
    border-radius: 10px;
    overflow: hidden;
    border: 1px solid #e0e0e0;
    font-size: 0.875rem;
  }

  :global(html[data-theme="dark"]) .article-body :global(.code-block-wrapper) {
    border-color: #2e2e2e;
  }

  .article-body :global(.code-block-header) {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: #e8e8e8;
    padding: 0.45rem 1rem;
    font-family: ui-monospace, 'SF Mono', Menlo, Consolas, monospace;
    font-size: 0.78rem;
    color: #555;
    user-select: none;
  }

  :global(html[data-theme="dark"]) .article-body :global(.code-block-header) {
    background-color: #252525;
    color: #888;
  }

  .article-body :global(.code-block-copy) {
    background: none;
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 0.2rem 0.55rem;
    font-size: 0.72rem;
    font-family: inherit;
    color: #555;
    cursor: pointer;
    transition: all 0.15s ease;
    line-height: 1.4;
  }

  :global(html[data-theme="dark"]) .article-body :global(.code-block-copy) {
    border-color: #444;
    color: #888;
  }

  .article-body :global(.code-block-copy:hover) {
    background-color: #d0d0d0;
    color: #222;
  }

  :global(html[data-theme="dark"]) .article-body :global(.code-block-copy:hover) {
    background-color: #333;
    color: #ddd;
  }

  .article-body :global(.code-block-copy.copied) {
    color: #2d8a4e;
    border-color: #2d8a4e;
  }

  .article-body :global(.code-block-wrapper pre) {
    margin-bottom: 0;
    border: none;
    border-radius: 0;
    background-color: #f7f7f7;
    padding: 1rem 1.25rem;
    overflow-x: auto;
    line-height: 1.65;
    white-space: pre;
  }

  :global(html[data-theme="dark"]) .article-body :global(.code-block-wrapper pre) {
    background-color: #1a1a1a;
  }

  .article-body :global(.code-block-wrapper pre code.hljs) {
    background: none;
    padding: 0;
    border-radius: 0;
    font-size: inherit;
    white-space: pre;
  }
</style>
