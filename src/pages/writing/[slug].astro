---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, render } from 'astro:content';
import config from '../../../config.json';

export async function getStaticPaths() {
  const articles = await getCollection('writing');
  return articles.map((article) => ({
    params: { slug: article.id },
    props: { article },
  }));
}

const { article } = Astro.props;
const { Content } = await render(article);

// Convert "February 22, 2026" → "2026-02-22" for datetime attribute
const dateISO = new Date(article.data.date).toISOString().slice(0, 10);
---

<BaseLayout
  title={`${article.data.title} — ${config.site_name}`}
  description={article.data.title}
  activeNav="writing"
>
  <a href="/writing" class="back-link">&larr; back to writing</a>

  <article>
    <header class="article-header">
      <h1 class="article-title">{article.data.title}</h1>
      <time class="article-date" datetime={dateISO}>{article.data.date}</time>
    </header>

    <div class="article-body">
      <Content />
    </div>
  </article>
</BaseLayout>

<script>
  // Copy button for code blocks
  document.querySelectorAll('.article-body pre').forEach((pre) => {
    const btn = document.createElement('button');
    btn.className = 'code-copy-btn';
    btn.setAttribute('aria-label', 'Copy code');
    btn.textContent = 'copy';

    pre.appendChild(btn);

    btn.addEventListener('click', () => {
      const code = pre.querySelector('code');
      if (!code) return;
      navigator.clipboard.writeText(code.innerText).then(() => {
        btn.textContent = 'copied!';
        btn.classList.add('copied');
        setTimeout(() => {
          btn.textContent = 'copy';
          btn.classList.remove('copied');
        }, 2000);
      });
    });
  });
</script>

<style>
  .back-link {
    color: var(--text-muted);
    font-size: 0.9rem;
    margin-bottom: 2rem;
    display: inline-block;
  }

  .article-header {
    margin-top: 1.5rem;
    margin-bottom: var(--space-lg);
  }

  .article-title {
    font-size: clamp(2rem, 4vw, 2.5rem);
    margin-bottom: 0.5rem;
    line-height: 1.1;
  }

  .article-date {
    font-family: monospace;
    color: var(--text-muted);
    font-size: 0.9rem;
  }

  /* Article body typography */
  .article-body {
    font-family: var(--font-serif);
    font-size: 1.15rem;
    line-height: 1.8;
    color: var(--text-main);
  }

  .article-body :global(p) {
    margin-bottom: 1.5rem;
  }

  .article-body :global(h2) {
    font-family: var(--font-sans);
    font-size: 1.75rem;
    font-weight: 700;
    letter-spacing: -0.02em;
    margin-top: 3rem;
    margin-bottom: 0.85rem;
    line-height: 1.2;
    padding-bottom: 0.4rem;
    border-bottom: 1px solid var(--border-color);
  }

  .article-body :global(h3) {
    font-family: var(--font-sans);
    font-size: 1.35rem;
    font-weight: 700;
    letter-spacing: -0.01em;
    margin-top: 2.5rem;
    margin-bottom: 0.6rem;
    line-height: 1.3;
  }

  .article-body :global(ul),
  .article-body :global(ol) {
    list-style: disc;
    padding-left: 1.75rem;
    margin-bottom: 1.5rem;
  }

  .article-body :global(ol) {
    list-style: decimal;
  }

  .article-body :global(li) {
    margin-bottom: 0.45rem;
  }

  .article-body :global(hr) {
    border: none;
    border-top: 1px dashed var(--border-color);
    margin: 2.5rem 0;
  }

  .article-body :global(blockquote) {
    border-left: 3px solid var(--border-color);
    padding: 0.25rem 0 0.25rem 1.25rem;
    color: var(--text-muted);
    margin: 0 0 1.5rem 0;
    font-style: italic;
  }

  /* Inline code */
  .article-body :global(code) {
    font-family: ui-monospace, 'SF Mono', Menlo, Consolas, 'Courier New', monospace;
    font-size: 0.85em;
    background-color: var(--border-color);
    padding: 0.15em 0.45em;
    border-radius: 4px;
  }

  :global(html[data-theme="dark"]) .article-body :global(code) {
    background-color: #2a2a2a;
  }

  /* Shiki code blocks — dual theme via CSS vars */
  .article-body :global(pre) {
    position: relative;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    padding: 1.1rem 1.25rem;
    overflow-x: auto;
    margin-bottom: 1.75rem;
    font-size: 0.88rem;
    line-height: 1.65;
  }

  /* Shiki inlines both themes; hide/show based on data-theme */
  :global(html:not([data-theme="dark"])) .article-body :global(pre .shiki.github-dark) {
    display: none;
  }

  :global(html[data-theme="dark"]) .article-body :global(pre .shiki.github-light) {
    display: none;
  }

  .article-body :global(pre code) {
    background: none;
    padding: 0;
    border-radius: 0;
    font-size: inherit;
  }

  /* Copy button */
  .article-body :global(pre) {
    position: relative;
  }

  .article-body :global(.code-copy-btn) {
    position: absolute;
    top: 0.5rem;
    right: 0.6rem;
    background: none;
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 0.2rem 0.55rem;
    font-size: 0.72rem;
    font-family: ui-monospace, 'SF Mono', Menlo, Consolas, monospace;
    color: #555;
    cursor: pointer;
    transition: all 0.15s ease;
    line-height: 1.4;
    opacity: 0;
    transition: opacity 0.15s ease;
  }

  .article-body :global(pre:hover .code-copy-btn) {
    opacity: 1;
  }

  :global(html[data-theme="dark"]) .article-body :global(.code-copy-btn) {
    border-color: #444;
    color: #888;
  }

  .article-body :global(.code-copy-btn:hover) {
    background-color: #d0d0d0;
    color: #222;
  }

  :global(html[data-theme="dark"]) .article-body :global(.code-copy-btn:hover) {
    background-color: #333;
    color: #ddd;
  }

  .article-body :global(.code-copy-btn.copied) {
    color: #2d8a4e;
    border-color: #2d8a4e;
    opacity: 1;
  }
</style>
